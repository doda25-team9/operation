---
- name: Finalization Playbook - Installing MetalLB, Nginx Ingress Controller
  hosts: all
  become: yes
  vars:
    metallb_url: "https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml"
    kubeconfig_path: "/etc/kubernetes/admin.conf"

  tasks:
    # Step 20: Install MetalLB and configure it
    - name: Apply MetalLB manifest
      ansible.builtin.command: kubectl apply -f {{ metallb_url }}
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"
      register: metallb_install
      changed_when: "'created' in metallb_install.stdout or 'configured' in metallb_install.stdout"

    - name: Wait for MetalLB controller to be ready
      ansible.builtin.command: >
        kubectl wait -n metallb-system
        -l app=metallb,component=controller
        --for=condition=ready pod
        --timeout=60s
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"
      changed_when: false

    - name: Copy MetalLB configuration file
      ansible.builtin.copy:
        src: metallb-config.yaml
        dest: /tmp/metallb-config.yaml
        mode: "0644"

    - name: Apply MetalLB configuration
      ansible.builtin.command: kubectl apply -f /tmp/metallb-config.yaml
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"

    # Step 21: Install Nginx Ingress Controller
    - name: Add Helm repository
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Create namespace for Ingress controller (for secrets)
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: ingress-nginx
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Copy certificate and key files to VM
      ansible.builtin.copy:
        src: "certificates/{{ item }}"
        dest: "/tmp/{{ item }}"
        mode: "0644"
      with_items:
          - tls.crt
          - tls.key

    - name: Create TLS secret for Ingress controller
      ansible.builtin.shell: |
        kubectl create secret tls self-signed-certificate-tls \
        --key=/tmp/tls.key \
        --cert=/tmp/tls.crt \
        -n ingress-nginx \
        --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Install Ingress chart
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        values:
          controller:
            ingressClassResource:
              name: nginx
              enabled: true
              default: true
            service:
              loadBalancerIP: "192.168.56.99"
            extraArgs:
              default-ssl-certificate: "ingress-nginx/self-signed-certificate-tls"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
