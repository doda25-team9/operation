---
- name: Finalization Playbook - Installing MetalLB, Nginx Ingress Controller
  hosts: all
  become: yes
  vars:
    metallb_url: "https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml"
    kubeconfig_path: "/etc/kubernetes/admin.conf"

  tasks:
    # Step 20: Install MetalLB and configure it
    - name: Apply MetalLB manifest
      ansible.builtin.command: kubectl apply -f {{ metallb_url }}
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"
      register: metallb_install
      changed_when: "'created' in metallb_install.stdout or 'configured' in metallb_install.stdout"

    - name: Wait for MetalLB controller to be ready
      ansible.builtin.command: >
        kubectl wait -n metallb-system
        -l app=metallb,component=controller
        --for=condition=ready pod
        --timeout=60s
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"
      changed_when: false

    - name: Copy MetalLB configuration file
      ansible.builtin.copy:
        src: metallb-config.yaml
        dest: /tmp/metallb-config.yaml
        mode: "0644"

    - name: Apply MetalLB configuration
      ansible.builtin.command: kubectl apply -f /tmp/metallb-config.yaml
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"

    # Step 21: Install Nginx Ingress Controller
    - name: Add Helm repository
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
      environment:
          KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Install chart
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        values:
          controller:
            ingressClassResource:
              name: nginx
              enabled: true
              default: true
            service:
              loadBalancerIP: "192.168.56.99"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # Step 22: Install Kubernetes Dashboard
    - name: Install Kubernetes Python library
      ansible.builtin.apt:
        name: python3-kubernetes
        state: present
        update_cache: yes

    - name: Add Kubernetes Dashboard Helm repo
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: "https://kubernetes.github.io/dashboard/"

    - name: Install Kubernetes Dashboard
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        release_namespace: kubernetes-dashboard
        create_namespace: true
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Copy dashboard manifests to the controller VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../manifests/"
        dest: "/tmp/manifests/"
        mode: '0644'

    - name: Apply admin-user ServiceAccount and RBAC
      ansible.builtin.shell: "kubectl apply -f /tmp/manifests/dashboard-admin-user.yml"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Create Ingress for Kubernetes Dashboard
      ansible.builtin.shell: "kubectl apply -f /tmp/manifests/dashboard-ingress.yml"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # Step 23: Install Istio
    - name: Download Istio 1.25.2
      ansible.builtin.get_url:
        url: https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-amd64.tar.gz
        dest: /tmp/istio.tar.gz
        mode: '0644'

    - name: Unpack Istio
      ansible.builtin.unarchive:
        src: /tmp/istio.tar.gz
        dest: /opt/
        remote_src: yes
        creates: /opt/istio-1.25.2

    - name: Add istioctl to global PATH
      ansible.builtin.file:
        src: /opt/istio-1.25.2/bin/istioctl
        dest: /usr/local/bin/istioctl
        state: link

    - name: Copy Istio configuration to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../manifests/istio-config.yml"
        dest: /tmp/istio-config.yml
        mode: '0644'

    - name: Install Istio using istioctl
      ansible.builtin.shell: "istioctl install -y -f /tmp/istio-config.yml"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
